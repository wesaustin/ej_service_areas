library(readr)
SDWA_LCR_SAMPLES <- read_csv("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/DWDB/Data/sdwis/SDWA_LCR_SAMPLES.csv")
View(SDWA_LCR_SAMPLES)
SDWA_violations <- read_csv("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/DWDB/Data/sdwis/SDWA_Violations.csv")
install.packages("xfun")
install.packages("xfun")
knitr::opts_chunk$set(echo = TRUE)
SDWA_violations <- read_csv("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/DWDB/Data/sdwis/SDWA_VIOLATIONS.csv")
SDWA_LCR_SAMPLES <- read_csv("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/DWDB/Data/sdwis/SDWA_LCR_SAMPLES.csv")
library(readr)
SDWA_violations <- read_csv("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/DWDB/Data/sdwis/SDWA_Violations.csv")
View(SDWA_violations)
SDWA_violations <- SDWA_violations %>%
filter(HEALTH_BASED == "Y")
library(dplyr)
SDWA_violations <- SDWA_violations %>%
filter(HEALTH_BASED == "Y")
# Check analytes
SDWA_violations %>%
group_by(HEALTH_BASED) %>%
summarise(n = n()) %>%
mutate(
totalN = (cumsum(n)),
percent = round((n / sum(n)), 3),
cumuPer = round(cumsum(freq = n / sum(n)), 3)) %>%
print(n = 100)
save(SDWA_violations, file = "C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/data/water quality/SDWA_vios_healthbased.Rdata")
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
readr,
tidyverse,
sf, # vector data operations
raster, # raster data operations
exactextractr, # fast raster data extraction for polygons
maps, # to get county boundary data
data.table, # data wrangling
dplyr, # data wrangling
lubridate, # Date object handling
tmap, # for map creation
modelsummary, # regression table generation
future.apply, # parallel computation
cdlTools, # download CDL data
rgdal, # required for cdlTools
prism, # download PRISM data
stringr, # string manipulation
magrittr,
tidycensus,
mapview
)
setwd("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/")
setwd("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/")
setwd("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/")
setwd("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/")
# setwd("C:/Users/tbardot/OneDrive - Environmental Protection Agency (EPA)/Documents/R_GIS/")
LCR_samp <- read_csv("data/water_quality/SDWA_LCR_SAMPLES.csv")
LCR_samp <- read_csv("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/data/water_quality/SDWA_LCR_SAMPLES.csv")
LCR_samp <- read_csv("data/water quality/SDWA_LCR_SAMPLES.csv")
SDWA_violations <- read_csv("data/water quality/SDWA_VIOLATIONS.csv")
#find the samples exceeding 0.015 mg/l lead and group by PWSID
LCR_exc <- LCR_samp %>%
filter(SAMPLE_MEASURE > 0.015)
#get counts for number of violations by PWSID
PWSID_LCR_exc <- LCR_exc %>%
group_by(PWSID) %>%
mutate(total_violations = n())
#Now select the max sample measure for each PSWID
PWSID_LCR_2 <- PWSID_LCR_exc %>%
ungroup(PWSID) %>%
filter(SAMPLE_MEASURE == max(SAMPLE_MEASURE), .by = PWSID)
#We now want to clean this data up, keeping only the total number of violations per PWSID and the maximum contamination in each
LCR_violations_per_PWSID <- PWSID_LCR_2 %>%
select(PWSID, SAMPLE_MEASURE, UNIT_OF_MEASURE, total_violations, SAMPLING_END_DATE) %>%
rename(Maximum_sample_exceedence = SAMPLE_MEASURE) %>%
rename(Units = UNIT_OF_MEASURE)
library(future.apply)
library(parallel)
LCR_violations_per_PWSID <- PWSID_LCR_2 %>%
select(PWSID, SAMPLE_MEASURE, UNIT_OF_MEASURE, total_violations, SAMPLING_END_DATE) %>%
rename(Maximum_sample_exceedence = SAMPLE_MEASURE) %>%
rename(Units = UNIT_OF_MEASURE)
#Now select the max sample measure for each PSWID
PWSID_LCR_2 <- PWSID_LCR_exc %>%
ungroup(PWSID) %>%
filter(SAMPLE_MEASURE == max(SAMPLE_MEASURE), .by = PWSID)
LCR_violations_per_PWSID <- PWSID_LCR_2 %>%
select(PWSID, SAMPLE_MEASURE, UNIT_OF_MEASURE, total_violations, SAMPLING_END_DATE) %>%
rename(Maximum_sample_exceedence = SAMPLE_MEASURE) %>%
rename(Units = UNIT_OF_MEASURE)
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
readr,
tidyverse,
sf, # vector data operations
raster, # raster data operations
exactextractr, # fast raster data extraction for polygons
maps, # to get county boundary data
data.table, # data wrangling
dplyr, # data wrangling
lubridate, # Date object handling
tmap, # for map creation
modelsummary, # regression table generation
future.apply, # parallel computation
cdlTools, # download CDL data
rgdal, # required for cdlTools
prism, # download PRISM data
stringr # string manipulation
)
LCR_violations_per_PWSID <- PWSID_LCR_2 %>%
select(PWSID, SAMPLE_MEASURE, UNIT_OF_MEASURE, total_violations, SAMPLING_END_DATE) %>%
rename(Maximum_sample_exceedence = SAMPLE_MEASURE) %>%
rename(Units = UNIT_OF_MEASURE)
LCR_violations_per_PWSID <- PWSID_LCR_2 %>%
dplyr::select(PWSID, SAMPLE_MEASURE, UNIT_OF_MEASURE, total_violations, SAMPLING_END_DATE) %>%
rename(Maximum_sample_exceedence = SAMPLE_MEASURE) %>%
rename(Units = UNIT_OF_MEASURE)
write.csv(LCR_violations_per_PWSID, "C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/ej_service_areas/data/indicators/LCR_violations_per_PWSID.csv")
LCR_violations <- read.csv("ej_service_areas/data/indicators/LCR_violations_per_PWSID.csv")
PWSID_geodemog_data <- read.csv("data/demographics/sb_dems_area_v3.csv")
PWSID_geodemog_data <- read.csv("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/data/demographics/sb_dems_area_v3.csv")
PWSID_geodemog_data <- read_excel("data/demographics/sb_dems_area_v3.xlsx")
library(readxl)
PWSID_geodemog_data <- read_excel("data/demographics/sb_dems_area_v3.xlsx")
LCR_viol_2 <- LCR_viol_inner %>%
group_by(ID) %>%
mutate(AVG_CBG_viol= mean(total_violations)) %>%
distinct(ID, .keep_all = TRUE)
LCR_viol_inner <- inner_join(LCR_violations, PWSID_geodemog_data, by = "PWSID")
rename(PWSID_geodemog_data, PWSID = pwsid)
PWSID_geodemog_data <- PWSID_geodemog_data %>%
rename(PWSID = pwsid)
LCR_viol_inner <- inner_join(LCR_violations, PWSID_geodemog_data, by = "PWSID")
LCR_viol_2 <- LCR_viol_inner %>%
group_by(ID) %>%
mutate(AVG_CBG_viol= mean(total_violations)) %>%
distinct(ID, .keep_all = TRUE)
epic_data <- st_read("epic_boundaries/temm.gpkg")
epic_boundaries <-  epic_data %>%
st_as_sf(sf_column_name=geom, crs=4326)
## Remove missing boundaries
epic_areas <- epic_data %>%
filter(!st_is_empty(.)) %>%
rename(PWSID = pwsid)
st_write(epic_areas, "generated_boundaries_from_epic.shp")
popup_id <- paste0("<strong>Name: </strong>",
epic_areas$pws_name)
#mapping the epic areas
library(leaflet)
leaflet(data= epic_areas) %>%
setView(-81,35, zoom=6) %>%
addTiles %>%
addPolygons(popup = popup_id)
##combine Epic boundaries with LCR violations data
LCR_viol_geodata <- inner_join(LCR_viol_2, epic_areas, by = "PWSID") %>%
distinct(ID, .keep_all = TRUE)
LCR_viol_geo_sf <- st_as_sf(LCR_viol_geodata)
LCR_plot_CA <- ggplot(data = LCR_viol_CA, aes(fill = AVG_CBG_viol)) +
geom_sf()
LCR_viol_CA <- LCR_viol_geo_sf %>%
filter(ST_ABBREV == "CA")
###Plot using ggplot2
LCR_plot_CA <- ggplot(data = LCR_viol_CA, aes(fill = AVG_CBG_viol)) +
geom_sf()
##make a subset for testing
LCR_viol_IL <- LCR_viol_geo_sf %>%
filter(ST_ABBREV == "IL")
LCR_plot_IL <- ggplot(data = LCR_viol_IL, aes(fill = AVG_CBG_viol)) +
geom_sf()
LCR_plot_IL
LCR_viol_CA <- LCR_viol_geo_sf %>%
filter(ST_ABBREV == "CA")
###Plot using ggplot2
LCR_plot_CA <- ggplot(data = LCR_viol_CA, aes(fill = AVG_CBG_viol)) +
geom_sf()
LCR_plot_CA
tmap_mode("view")
tm_shape(LCR_viol_CA) +
tm_polygons(col = "AVG_CBG_viol", midpoint = 0) +
tm_basemap("Esri.WorldTopoMap")
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
readr,
tidyverse,
sf, # vector data operations
raster, # raster data operations
exactextractr, # fast raster data extraction for polygons
maps, # to get county boundary data
data.table, # data wrangling
dplyr, # data wrangling
lubridate, # Date object handling
tmap, # for map creation
modelsummary, # regression table generation
future.apply, # parallel computation
cdlTools, # download CDL data
rgdal, # required for cdlTools
prism, # download PRISM data
stringr, # string manipulation
magrittr,
tidycensus,
mapview
)
Lead_violations <- read.csv("ej_service_areas/data/indicators/LCR_violations_per_PWSID.csv")
setwd("C:/Users/gaustin/OneDrive - Environmental Protection Agency (EPA)/NCEE - Water System Service Boundaries/")
Lead_violations <- read.csv("ej_service_areas/data/indicators/LCR_violations_per_PWSID.csv")
PWSID_geodemog_data <- read_excel("data/demographics/sb_dems_area_v3.xlsx")
Lead_violations <- left_join(PWSID_geodemog_data, Lead_violations, by = "PWSID", relationship = "many-to-many")
PWSID_geodemog_data <- read_excel("data/demographics/sb_dems_area_v3.xlsx")
## Load packages:
if (!require("pacman")) install.packages("pacman")
pacman::p_load(
readr,
tidyverse,
sf, # vector data operations
raster, # raster data operations
exactextractr, # fast raster data extraction for polygons
maps, # to get county boundary data
data.table, # data wrangling
dplyr, # data wrangling
lubridate, # Date object handling
tmap, # for map creation
modelsummary, # regression table generation
future.apply, # parallel computation
cdlTools, # download CDL data
rgdal, # required for cdlTools
prism, # download PRISM data
stringr, # string manipulation
magrittr,
tidycensus,
mapview
)
library(readxl)
PWSID_geodemog_data <- read_excel("data/demographics/sb_dems_area_v3.xlsx")
Lead_violations$total_violations[is.na(Lead_violations$total_violations)] <- 0
Lead_violations <- left_join(PWSID_geodemog_data, Lead_violations, by = "PWSID", relationship = "many-to-many")
View(Lead_violations)
Lead_violations <- read.csv("ej_service_areas/data/indicators/LCR_violations_per_PWSID.csv")
PWSID_geodemog_data <- PWSID_geodemog_data %>%
rename(PWSID = pwsid)
Lead_violations <- left_join(PWSID_geodemog_data, Lead_violations, by = "PWSID", relationship = "many-to-many")
View(Lead_violations)
Lead_violations$total_violations[is.na(Lead_violations$total_violations)] <- 0
Lead_violations$Maximum_sample_exceedence[is.na(Lead_violations$Maximum_sample_exceedence)] <- 0
Lead_violations <- Lead_violations %>%
group_by(ID) %>%
mutate(avg_viol_CBG = mean(total_violations)) %>%
distinct(ID, .keep_all = TRUE)
##make a subset for testing, create tract-level unit of analysis
Lead_viol_AL <- Lead_violations %>%
filter(ST_ABBREV == "AL") %>%
mutate(tract = substring(ID, first=1, last=11)) %>%
group_by(tract) %>%
mutate(AVG_tract_viol = mean(total_violations))
##Grab AL block group boundaries
AL_bg <- tigris::block_groups("AL") %>%
mutate(ID = substring(GEOID, first=2, last=12)) %>%
st_transform(crs = 4326)
AL_bg$ID <- as.numeric(AL_bg$ID)
AL_bg$ID <- as.numeric(AL_bg$ID)
##We actually only have tract-level data for AL? It appears that there is a number (0)
##missing from the CBG ID, which is why I had to substring in order to match the polygons
st_crs(AL_bg)
st_crs(health_viol_AL)
Lead_viol_AL <- left_join(AL_bg, Lead_viol_AL)
AL_bg$ID <- as.numeric(AL_bg$ID)
Lead_viol_AL <- left_join(AL_bg, Lead_viol_AL)
Lead_viol_AL$ID <- as.numeric(Lead_viol_AL$ID)
Lead_viol_AL <- left_join(AL_bg, Lead_viol_AL)
st_as_sf(Lead_viol_AL)
###Plot using ggplot2
Lead_plot_AL <- ggplot() +
geom_sf(data = Lead_viol_AL, aes(fill = avg_viol_CBG, geometry = geometry)) +
scale_fill_viridis_c(option="plasma", na.value = "white") +
geom_sf(data = AL_bg, fill = NA) +
ggthemes::theme_map() +
theme(legend.position = "right")
Lead_plot_AL
##NJ : CBG
Lead_viol_NJ <- Lead_violations %>%
filter(ST_ABBREV == "NJ") %>%
mutate(tract = substring(ID, first=1, last=11)) %>%
group_by(tract) %>%
mutate(AVG_tract_viol = mean(total_violations))
NJ_bg <- tigris::block_groups("NJ") %>%
mutate(ID = GEOID) %>%
st_transform(crs = 4326)
NJ_bg$ID <- as.numeric(NJ_bg$ID)
Lead_viol_NJ <- left_join(NJ_bg, Lead_viol_NJ)
Lead_viol_NJ$ID <- as.numeric(Lead_viol_NJ$ID)
st_as_sf(Lead_viol_NJ)
Lead_viol_NJ$ID <- as.numeric(Lead_viol_NJ$ID)
Lead_viol_NJ <- left_join(NJ_bg, Lead_viol_NJ)
st_as_sf(Lead_viol_NJ)
Lead_plot_NJ <- ggplot() +
geom_sf(data = Lead_viol_NJ, aes(fill = avg_viol_CBG, geometry = geometry)) +
scale_fill_viridis_c(option="plasma", na.value = "white") +
geom_sf(data = NJ_bg, fill = NA) +
ggthemes::theme_map() +
theme(legend.position = "right")
Lead_plot_NJ
NJ_tract <- tigris::tracts("NJ") %>%
mutate(tract = GEOID) %>%
st_transform(crs = 4326)
Lead_viol_NJ <- left_join(NJ_tract, Lead_viol_NJ)
Lead_viol_NJ <- st_join(NJ_tract, Lead_viol_NJ)
st_as_sf(Lead_viol_NJ)
Lead_plot_NJ <- ggplot() +
geom_sf(data = Lead_viol_NJ, aes(fill = AVG_tract_viol, geometry = geometry)) +
scale_fill_viridis_c(option="plasma", na.value = "white") +
geom_sf(data = NJ_tract, fill = NA) +
ggthemes::theme_map() +
theme(legend.position = "right")
Lead_plot_NJ
Lead_plot_NJ
Lead_plot_NJ
rm(lead_viol_NJ)
Lead_viol_NJ <- Lead_violations %>%
filter(ST_ABBREV == "NJ") %>%
mutate(tract = substring(ID, first=1, last=11)) %>%
group_by(tract) %>%
mutate(AVG_tract_viol = mean(total_violations))
Lead_viol_NJ <- left_join(NJ_tract, Lead_viol_NJ)
# double check if this is a st_join or a left join, i.e., is this spatially joining locations
# or is it joining by an ID
st_as_sf(Lead_viol_NJ)
Lead_plot_NJ <- ggplot() +
geom_sf(data = Lead_viol_NJ, aes(fill = AVG_tract_viol, geometry = geometry)) +
scale_fill_viridis_c(option="plasma", na.value = "white") +
geom_sf(data = NJ_tract, fill = NA) +
ggthemes::theme_map() +
theme(legend.position = "right")
Lead_plot_NJ
Lead_plot_NJ
Lead_plot_NJ
##Interactive map (similar to leaflet)
tmap_mode("view")
tm_shape(LCR_viol_CA) +
tm_polygons(col = "AVG_CBG_viol", midpoint = 0) +
tm_basemap("Esri.WorldTopoMap")
tmap_mode("view")
tm_shape(Lead_viol_NJ) +
tm_polygons(col = "AVG_CBG_viol", midpoint = 0) +
tm_basemap("Esri.WorldTopoMap")
tmap_mode("view")
tm_shape(Lead_viol_NJ) +
tm_polygons(col = "AVG_tract_viol", midpoint = 0) +
tm_basemap("Esri.WorldTopoMap")
LCR_lm <- lm(avg_viol_CBG ~ MINORPCT + PRE1960PCT + LOWINCPCT, data = Lead_viol_NJ)
summary(LCR_lm)
View(Lead_viol_NJ)
sum(Lead_viol_NJ$avg_viol_CBG)
mean <- mean(Lead_viol_NJ$avg_viol_CBG)
mean
describe(health_viol_NJ[c("avg_CBG_viol", "ACSTOTPOP", "MINORPCT","PRE1960PCT", "LOWINCPCT")])
install.packages("psych")
library(psych)
describe(health_viol_NJ[c("avg_CBG_viol", "ACSTOTPOP", "MINORPCT","PRE1960PCT", "LOWINCPCT")])
describe(Lead_viol_NJ[c("avg_CBG_viol", "ACSTOTPOP", "MINORPCT","PRE1960PCT", "LOWINCPCT")])
describe(Lead_viol_NJ[c("avg_viol_CBG", "ACSTOTPOP", "MINORPCT","PRE1960PCT", "LOWINCPCT")])
describe(Lead_viol_NJ[c("avg_viol_CBG")])
mean(Lead_viol_NJ$avg_viol_CBG)
mean(Lead_viol_NJ$avg_viol_CBG, na.rm= T)
summary(LCR_lm)
LCR_lm <- lm(avg_viol_CBG ~ MINORPCT + CANCER + PTRAF + PM25 + PRE1960PCT + LOWINCPCT, data = Lead_viol_NJ)
summary(LCR_lm)
